# ProConnect — Docker Compose (Development & Production)
# Deploy via: docker compose up -d

services:
  # ─── PostgreSQL ──────────────────────────────────────────
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: proconnect
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DB: proconnect
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./init-db:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U proconnect"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ─── ProConnect (Next.js Portal) ────────────────────────
  portal:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "3000:3000"
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://proconnect:${POSTGRES_PASSWORD:-changeme}@db:5432/proconnect
      LOGTO_ENDPOINT: ${LOGTO_ENDPOINT}
      LOGTO_APP_ID: ${LOGTO_APP_ID}
      LOGTO_APP_SECRET: ${LOGTO_APP_SECRET}
      LOGTO_COOKIE_SECRET: ${LOGTO_COOKIE_SECRET}
      LOGTO_BASE_URL: ${LOGTO_BASE_URL:-http://localhost:3000}
      AZURE_TENANT_ID: ${AZURE_TENANT_ID}
      AZURE_CLIENT_ID: ${AZURE_CLIENT_ID}
      AZURE_CLIENT_SECRET: ${AZURE_CLIENT_SECRET}
  # ─── Logto Auth Server ─────────────────────────────────
  logto:
    image: svhd/logto:latest
    restart: unless-stopped
    ports:
      - "3301:3301"
      - "3302:3302"
    environment:
      TRUST_PROXY_HEADER: "1"
      DB_URL: postgresql://proconnect:${POSTGRES_PASSWORD:-changeme}@db:5432/logto
      ENDPOINT: ${LOGTO_ENDPOINT:-http://localhost:3301}
      ADMIN_ENDPOINT: http://localhost:3302
    depends_on:
      db:
        condition: service_healthy

volumes:
  pg_data:
