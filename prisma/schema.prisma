// ProConnect — MortgagePros Employee Portal
// Prisma Schema for PostgreSQL

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Models ───────────────────────────────────────────────

model User {
  id          String   @id @default(cuid())
  logtoId     String   @unique
  email       String   @unique
  displayName String
  role        Role     @default(EMPLOYEE)
  avatarUrl   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  kudosSent      KudosMessage[]  @relation("KudosAuthor")
  kudosReceived  KudosMessage[]  @relation("KudosRecipient")
  kudosReactions KudosReaction[]
  alertsCreated  Alert[]
  notifications  Notification[]

  @@map("users")
}

model KudosMessage {
  id          String   @id @default(cuid())
  content     String
  authorId    String
  recipientId String
  badge       String   @default("mvp")
  author      User     @relation("KudosAuthor", fields: [authorId], references: [id])
  recipient   User     @relation("KudosRecipient", fields: [recipientId], references: [id])
  reactions   KudosReaction[]
  likes       Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([authorId])
  @@index([recipientId])
  @@index([createdAt])
  @@map("kudos_messages")
}

model KudosReaction {
  id        String            @id @default(cuid())
  kudosId   String
  userId    String
  reaction  KudosReactionType
  kudos     KudosMessage      @relation(fields: [kudosId], references: [id], onDelete: Cascade)
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime          @default(now())

  @@unique([kudosId, userId, reaction])
  @@index([kudosId, reaction])
  @@index([userId])
  @@map("kudos_reactions")
}

model Alert {
  id        String    @id @default(cuid())
  title     String
  content   String
  type      AlertType @default(INFO)
  priority  Priority  @default(LOW)
  active    Boolean   @default(true)
  createdBy String
  author    User      @relation(fields: [createdBy], references: [id])
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([active, priority])
  @@index([createdBy])
  @@map("alerts")
}

model Idea {
  id          String     @id @default(cuid())
  title       String
  description String
  authorId    String
  authorName  String
  votes       Int        @default(0)
  status      IdeaStatus @default(ACTIVE)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  votesBy     IdeaVote[]

  @@index([status, votes])
  @@index([createdAt])
  @@map("ideas")
}

model IdeaVote {
  id           String        @id @default(cuid())
  ideaId       String
  voterLogtoId String
  direction    VoteDirection
  createdAt    DateTime      @default(now())
  idea         Idea          @relation(fields: [ideaId], references: [id], onDelete: Cascade)

  @@unique([ideaId, voterLogtoId])
  @@index([voterLogtoId])
  @@map("idea_votes")
}

model QuickLink {
  id        String   @id @default(cuid())
  label     String
  url       String
  icon      String   @default("link")
  sortOrder Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active, sortOrder])
  @@map("quick_links")
}

model EmployeeHighlight {
  id           String   @id @default(cuid())
  employeeId   String?
  employeeName String
  jobTitle     String?
  department   String?
  title        String
  subtitle     String
  avatarUrl    String?
  active       Boolean  @default(true)
  startDate    DateTime @default(now())
  endDate      DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([active, startDate])
  @@map("employee_highlights")
}

model SiteBranding {
  id          String   @id @default("singleton")
  companyName String   @default("MortgagePros")
  logoData    String?  @db.Text // base64 data URL for logo image
  faviconData String?  @db.Text // base64 data URL for favicon
  updatedAt   DateTime @updatedAt

  @@map("site_branding")
}

model DirectorySnapshot {
  id                String   @id
  displayName       String   @map("display_name")
  mail              String?
  userPrincipalName String   @map("user_principal_name")
  jobTitle          String?  @map("job_title")
  employeeType      String?  @map("employee_type")
  department        String?
  officeLocation    String?  @map("office_location")
  managerId         String?  @map("manager_id")
  syncedAt          DateTime @default(now()) @map("synced_at")

  @@index([managerId])
  @@index([displayName])
  @@map("directory_snapshots")
}

model DirectorySnapshotState {
  id           String   @id
  lastSyncedAt DateTime? @map("last_synced_at")
  updatedAt    DateTime @default(now()) @map("updated_at")

  @@map("directory_snapshot_state")
}

// ─── Enums ────────────────────────────────────────────────

enum ForwardingStatus {
  PENDING    // Saved but not yet active (future start date)
  ACTIVE     // Forwarding rule currently enabled in Graph
  EXPIRED    // End date passed, rule removed
  CANCELLED  // User manually disabled
}

enum Role {
  ADMIN
  EMPLOYEE
}

enum AlertType {
  INFO
  WARNING
  BIRTHDAY
  NEW_HIRE
  ANNOUNCEMENT
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IdeaStatus {
  ACTIVE
  SELECTED
  ARCHIVED
}

enum VoteDirection {
  UP
  DOWN
}

enum TournamentStatus {
  SETUP
  IN_PROGRESS
  COMPLETED
}

enum MatchStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

// ─── Notifications ────────────────────────────────────────

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  metadata  String?          @db.Text // JSON blob for extra context (link, sender, etc.)
  createdAt DateTime         @default(now())

  @@index([userId, read, createdAt])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  KUDOS
  HIGHLIGHT
  IDEA_SELECTED
}

enum KudosReactionType {
  HIGHFIVE
  UPLIFT
  BOMB
}

// ─── Calendar / Holidays ──────────────────────────────────

model Holiday {
  id        String   @id @default(cuid())
  title     String
  date      String   // Format: YYYY-MM-DD
  category  String   // federal, fun, company
  color     String   @default("#06427F")
  source    String   @default("custom") // custom, nager, calendarific, etc.
  visible   Boolean  @default(true)
  recurring Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@index([category])
  @@index([visible])
  @@map("holidays")
}

model CalendarSyncLog {
  id       String   @id @default(cuid())
  source   String   // nager, calendarific, etc.
  status   String   // success, error
  message  String?
  syncedAt DateTime @default(now())

  @@index([syncedAt])
  @@map("calendar_sync_logs")
}

model CalendarSetting {
  id        String   @id @default("singleton")
  data      String   @default("{}") @db.Text // JSON blob for category labels, API configs, etc.
  updatedAt DateTime @updatedAt

  @@map("calendar_settings")
}

// ─── OOO Email Forwarding Schedule ────────────────────────

model ForwardingSchedule {
  id              String           @id @default(cuid())
  userEmail       String           // UPN / email of the mailbox owner
  forwardToEmail  String           // Where to forward
  forwardToName   String?          // Display name of recipient
  startsAt        DateTime         // When forwarding should activate
  endsAt          DateTime         // When forwarding should deactivate
  status          ForwardingStatus @default(PENDING)
  graphRuleId     String?          // ID of the Graph inbox rule (if created)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([status, startsAt])
  @@index([status, endsAt])
  @@index([userEmail, status])
  @@map("forwarding_schedules")
}

// ─── Tournament Bracket Models ────────────────────────────

model Tournament {
  id          String           @id @default(cuid())
  name        String
  description String?
  status      TournamentStatus @default(SETUP)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  teams   TournamentTeam[]
  matches TournamentMatch[]

  @@index([status])
  @@map("tournaments")
}

model TournamentTeam {
  id           String @id @default(cuid())
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  player1Name  String
  player2Name  String
  seed         Int       @default(0)
  division     String    // "West", "East", "South", "Mid-West"
  createdAt    DateTime  @default(now())

  matchesAsTeam1 TournamentMatch[] @relation("MatchTeam1")
  matchesAsTeam2 TournamentMatch[] @relation("MatchTeam2")
  matchesWon     TournamentMatch[] @relation("MatchWinner")

  @@index([tournamentId, division])
  @@map("tournament_teams")
}

model TournamentMatch {
  id           String      @id @default(cuid())
  tournamentId String
  tournament   Tournament  @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  round        Int         // 1 = first round, 2 = second round, etc.
  matchNumber  Int         // position within the round
  division     String      // "West", "East", "South", "Mid-West", "SemiFinal", "Final"
  team1Id      String?
  team1        TournamentTeam? @relation("MatchTeam1", fields: [team1Id], references: [id], onDelete: SetNull)
  team2Id      String?
  team2        TournamentTeam? @relation("MatchTeam2", fields: [team2Id], references: [id], onDelete: SetNull)
  winnerId     String?
  winner       TournamentTeam? @relation("MatchWinner", fields: [winnerId], references: [id], onDelete: SetNull)
  team1Score   Int?
  team2Score   Int?
  status       MatchStatus @default(PENDING)
  nextMatchId  String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([tournamentId, round, division])
  @@index([nextMatchId])
  @@map("tournament_matches")
}
